<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>DomePort Remake</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background: #111; }
    .ui { position:absolute; z-index:10; top:12px; left:12px; display:flex; gap:8px; font:14px/1.2 system-ui,sans-serif; }
    .ui button { padding:8px 12px; border-radius:8px; border:0; background:#2E7DFF; color:#fff; cursor:pointer; }
    .ui button[disabled]{opacity:.6; cursor:default;}
    #fileInput{ position:fixed; left:-9999px; }
  </style>
</head>
<body>

  <!-- UI 2D simple (backup) -->
  <div class="ui">
    <button id="uploadBtn">Upload video</button>
    <button id="playBtn" style="display:none;">Play</button>
  </div>
  <input id="fileInput" type="file" accept="video/*" />

  <a-scene vr-mode-ui="enabled: true" renderer="antialias: true">
    <!-- Caméra + HUD 3D -->
    <a-entity id="rig">
      <a-entity id="cam" camera look-controls wasd-controls position="0 1.6 3">
        <!-- HUD : 2 boutons 3D devant la caméra -->
        <a-entity id="hud" position="0 -0.25 -1.1">
          <!-- Bouton Play/Pause -->
          <a-entity id="btnPlay3D" class="clickable"
                    geometry="primitive: plane; width: 0.36; height: 0.12"
                    material="color: #2E7DFF; transparent: true; opacity: 0.95"
                    position="-0.21 0 0">
            <a-text id="btnPlay3DLabel" value="Play" align="center" width="1.6" position="0 0 0.01"></a-text>
          </a-entity>

          <!-- Bouton Upload (toujours visible, sélectionnable au laser) -->
          <a-entity id="btnUpload3D" class="clickable"
                    geometry="primitive: plane; width: 0.36; height: 0.12"
                    material="color: #43A047; transparent: true; opacity: 0.95"
                    position="0.21 0 0">
            <a-text id="btnUpload3DLabel" value="Upload" align="center" width="1.6" position="0 0 0.01"></a-text>
          </a-entity>
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- Curseur souris (rayon) pour cliquer en desktop -->
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>

    <!-- Contrôleurs VR avec lasers (clic = gâchette) -->
    <a-entity id="leftHand"  laser-controls="hand: left"  raycaster="objects: .clickable" cursor="rayOrigin: entity"></a-entity>
    <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .clickable" cursor="rayOrigin: entity"></a-entity>

    <!-- Ciel -->
    <a-sky color="#222"></a-sky>

    <!-- Assets -->
    <a-assets>
      <img id="ground" src="assets/GridBlack.jpg" crossorigin="anonymous">
      <video id="vid" crossorigin="anonymous" playsinline webkit-playsinline preload="auto"></video>
      <a-asset-item id="sato210" src="assets/sato210.obj"></a-asset-item>
    </a-assets>

    <!-- Dôme (noir par défaut) -->
    <a-entity id="dome"
              obj-model="obj: #sato210"
              material="shader: flat; color: #000; side: double"
              position="0 0 0"
              scale="-1 1 1">
    </a-entity>

    <!-- Sol quadrillé -->
    <a-plane material="src: #ground; repeat: 50 50; side: double"
             width="100" height="100" rotation="-90 0 0"></a-plane>
  </a-scene>

  <script>
    // Références UI
    const uploadBtn = document.getElementById('uploadBtn');
    const playBtn   = document.getElementById('playBtn');
    const fileInput = document.getElementById('fileInput');

    // Vidéo & dôme
    const videoEl = document.getElementById('vid');
    const domeEl  = document.getElementById('dome');

    // Boutons 3D
    const btnPlay3D        = document.getElementById('btnPlay3D');
    const btnPlay3DLabel   = document.getElementById('btnPlay3DLabel');
    const btnUpload3D      = document.getElementById('btnUpload3D');

    const BUTTONS_3D = [btnPlay3D, btnUpload3D];

    // Helpers
    const setUploadBtn = (txt, dis=false) => { uploadBtn.textContent = txt; uploadBtn.disabled = dis; };
    const mapVideo = (colorHex) => {
      domeEl.setAttribute('material', { shader: 'flat', side: 'double', color: colorHex, src: '#vid' });
      const m = domeEl.components?.material?.material; if (m) m.needsUpdate = true;
    };
    const setButtonsOpacity = (alpha) => {
      BUTTONS_3D.forEach(el => el.setAttribute('material','opacity', alpha));
    };
    const setPlayLabel = () => {
      btnPlay3DLabel.setAttribute('value', videoEl.paused ? 'Play' : 'Pause');
    };

    // Ouvrir le sélecteur de fichier (2D)
    uploadBtn.addEventListener('click', () => fileInput.click());

    // Ouvrir le sélecteur via bouton 3D Upload (laser/souris)
    const triggerUpload = () => fileInput.click();
    btnUpload3D.addEventListener('click', triggerUpload);

    // Gestion du fichier choisi
    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (!file) return;

      if (!file.type.startsWith('video/')) {
        alert('Please choose a video file (MP4 H.264/AAC or WebM VP9/Opus).');
        return;
      }

      // État UI
      setUploadBtn('loading', true);
      playBtn.style.display = 'none';

      // Préparer la vidéo
      const url = URL.createObjectURL(file);
      videoEl.setAttribute('playsinline','');
      videoEl.setAttribute('webkit-playsinline','');
      videoEl.setAttribute('preload','auto');
      videoEl.muted = true; // pour primer 1 frame
      videoEl.src = url;
      videoEl.load();

      // Dès que la 1ère frame est décodable
      const onLoaded = () => {
        // 1) Mapper la vidéo en gardant le dôme noir
        mapVideo('#000');

        // 2) Jouer 1 frame, puis révéler en blanc sans flash
        const reveal = () => {
          videoEl.pause();
          mapVideo('#FFF');
          setUploadBtn('Upload video', false);
          playBtn.style.display = 'inline-block';
          setPlayLabel();         // maj label 3D
          setButtonsOpacity(0.95);   // revenir semi-opaque après prime (au repos)
        };

        // Prime propre avec rVFC si dispo
        if (typeof videoEl.requestVideoFrameCallback === 'function') {
          videoEl.play().then(() => {
            videoEl.requestVideoFrameCallback(() => reveal());
          }).catch(() => {
            const once = () => { videoEl.removeEventListener('timeupdate', once); reveal(); };
            videoEl.addEventListener('timeupdate', once, { once: true });
            videoEl.play().catch(()=>{});
          });
        } else {
          const once = () => { videoEl.removeEventListener('timeupdate', once); reveal(); };
          videoEl.addEventListener('timeupdate', once, { once: true });
          videoEl.play().catch(()=>{});
        }

        videoEl.removeEventListener('loadeddata', onLoaded);
      };
      videoEl.addEventListener('loadeddata', onLoaded);

      // Erreur
      videoEl.addEventListener('error', () => {
        alert('Unsupported video. Convert to MP4 (H.264 + AAC) or WebM (VP9 + Opus).');
        setUploadBtn('Upload video', false);
        playBtn.style.display = 'none';
        domeEl.setAttribute('material', 'color', '#000');
      }, { once: true });
    });

    // Bouton 2D Play (backup)
    playBtn.addEventListener('click', () => {
      if (!videoEl.src) return;
      videoEl.muted = false;
      videoEl.play().catch(err => console.warn('Play blocked:', err));
    });

    // === Interactions 3D ===
    // Hover léger (mise en valeur) au laser / souris
    const addHoverFX = (el) => {
      el.addEventListener('mouseenter', () => el.setAttribute('scale', '1.05 1.05 1'));
      el.addEventListener('mouseleave', () => el.setAttribute('scale', '1 1 1'));
    };
    BUTTONS_3D.forEach(addHoverFX);

    // Clic Play/Pause (souris + contrôleurs VR)
    btnPlay3D.addEventListener('click', () => {
      if (!videoEl.src) return;
      if (videoEl.paused) {
        videoEl.muted = false;
        videoEl.play().catch(()=>{});
      } else {
        videoEl.pause();
      }
      setPlayLabel();
    });

    // Opacité auto des boutons 3D selon l’état de la vidéo
    videoEl.addEventListener('play',  () => { setButtonsOpacity(0.5);  setPlayLabel(); });
    videoEl.addEventListener('pause', () => { setButtonsOpacity(0.95); setPlayLabel(); });
    videoEl.addEventListener('ended', () => { setButtonsOpacity(0.95); setPlayLabel(); });
  </script>
</body>
</html>
